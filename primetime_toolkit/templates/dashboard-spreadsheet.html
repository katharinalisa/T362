{% extends 'layout.html' %} {% block content %}

<style>
  .dashboard-chart {
    box-shadow: 0 8px 32px rgba(34, 60, 80, 0.18);
    transition: box-shadow 0.2s, transform 0.2s;
    border-radius: 30px;
    border: none;
    background: #fff;
  }
  .dashboard-chart:hover {
    box-shadow: 0 16px 48px rgba(34, 60, 80, 0.32);
    transform: translateY(-8px) scale(1.04);
    z-index: 2;
  }

  @keyframes fadeInSlow {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .fade-in-slow {
    animation: fadeInSlow 1.8s ease-out forwards;
    animation-delay: 1s;
  }

  .option-card {
    background: linear-gradient(100deg, #eaf1fe 0%, #e6fcfa 100%);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .option-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.08);
  }

  .btn-start {
    background-color: #009687;
    color: #fff;
    border: none;
    transition: background-color 0.3s ease;
    text-decoration: none;
  }

  .btn-start:hover {
    background-color: #007f73;
    color: #fff;
  }
</style>

<section
  class="hero-section text-center py-4"
  style="width: 100vw; margin-left: calc(-50vw + 50%); margin-top: -28px">
  <div class="container"><br>
    <h1
      class="display-1 section-title mb-2"
      style="font-size: 3rem; font-weight: 800; text-align: center; letter-spacing: -0.6px;"
    >
      Your Financial Dashboard
    </h1>

    {% if data.net_worth is defined and data.net_worth is not none %}
      <p style="color:#787878">
        This is your Dashboard based on your uploaded <strong style="color:#007f73">Excel spreadsheet</strong>. Here you can view your financial stability and evaluate your current financial situation. We recommend calculating your finances at least every 6 months.
      </p>
    {% else %}
      <br>
      <p class="fade-in-slow" style="font-size: 17px;">
        It looks like you havenâ€™t uploaded a spreadsheet nor completed the web calculators yet.<br>
        Please choose one of the above options to get started and come back to your <strong>Dashboard</strong> once you have completed one of them.<br>
      </p>
    {% endif %}
  </div>
  <a href="{{ url_for('views.dashboard') }}" class="btn btn-outline-secondary mt-4">Back to Dashboard Options</a>
</section><br>

<script>
  document.addEventListener('DOMContentLoaded', () => {

      const fileInput = document.getElementById('budget_file');
      const uploadBtn = document.getElementById('uploadBtn');

      if (fileInput != null) {
        fileInput.addEventListener('change', function() {
          if (fileInput.files.length > 0) {
            uploadBtn.disabled = false;
            uploadBtn.classList.remove('btn-outline-primary');
            uploadBtn.classList.add('btn-success');
          } else {
            uploadBtn.disabled = true;
            uploadBtn.classList.remove('btn-success');
            uploadBtn.classList.add('btn-outline-primary');
          }
        });
      }
        
    });
</script>

<div class="container-fluid py-4">
  <!-- First row: three charts -->
  <div class="row g-4 mb-5">
    <div class="col-md-4">
      <div class="dashboard-chart p-3 text-center"
        style="height: 320px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <h5 style="margin-top: -35px" class="mb-2">Current Net Worth</h5><br>
        <div style="font-size:2.5rem; font-weight:700; color:#3bb3c3;">
          {% if data.net_worth is defined and data.net_worth is not none %}
            ${{ "{:,.2f}".format(data.net_worth) }}
          {% else %}
            <span class="text-muted">Please upload a spreadsheet to calculate your net worth</span>
          {% endif %}
        </div>

        <span class="text-muted mt-2">Calculated from your assets and liabilities</span>
        <canvas id="netWorthChart" style="max-width: 100%; max-height: 220px; display:none;"></canvas>
      </div>
    </div>
    <div class="col-md-4 ">
      <div class="dashboard-chart p-3 text-center"
        style="height: 320px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <h5 class="mb-2">Assets vs Liabilities</h5>
        <canvas id="assetsLiabilitiesChart" style="max-width: 100%; max-height: 220px;"></canvas>
      </div>
    </div>
    <div class="col-md-4">
      <div class="dashboard-chart p-3 text-center"
        style="height: 320px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <h5 class="mb-2">Monthly Savings</h5>
        <div style="font-size:2.5rem; font-weight:700; color:#3bb3c3;">
          <!-- monthly surplus or deficit -->
           {% if data.monthly_savings is defined and data.monthly_savings is not none %}
            ${{ "{:,.2f}".format(data.monthly_savings) }}
           {% else %}
            <span class="text-muted mt-2">Income minus expenses</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  
  <!-- Second row: two wide charts -->
  <div class="row g-4 mb-5">
    <div class="col-md-6">
      <div class="dashboard-chart p-3 text-center"
        style="height: 320px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <h5 class="mb-2">Subscription Amount ($)</h5>
        <div style="font-size:2.5rem; font-weight:700; color:#3bb3c3;">
          {% if data.subscriptions is defined and data.subscriptions is not none %}
            ${{ "{:,.2f}".format(data.subscriptions.total) }}
          {% else %}
            <span class="text-muted">Please provide your subscriptions in spreadsheet subscriptions</span>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="dashboard-chart p-3 text-center"
        style="height: 320px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <h5 class="mb-2">Monthly Expenses</h5>
        <div style="font-size:2.5rem; font-weight:700; color:#3bb3c3;">
          {% if data.expenses is defined and data.expenses is not none %}
            ${{ "{:,.2f}".format(data.expenses.total) }}
          {% else %}
            <span class="text-muted">Please provide your expenses in spreadsheet</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <!-- Third row: three charts -->
  <div class="row g-4 mb-5">
    <div class="col-md-4">
      <div class="dashboard-chart p-3 text-center"
        style="height: 320px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <h5 class="mb-2">Superannuation Growth</h5>
        {% if data.super is defined and data.super is not none %}
            <canvas id="superGrowthChart" style="max-width: 100%; max-height: 220px;"></canvas>
           
        {% else %}
          <span class="text-muted">Please calculate your superannuation growth</span>
        {% endif %}
      </div>
    </div>
    <div class="col-md-4">
      <div class="dashboard-chart p-3 text-center"
        style="height: 320px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <h5 class="mb-2">Expense Breakdown</h5>
        <canvas id="expenseBreakdownChart" style="max-width: 100%; max-height: 220px;"></canvas>
      </div>
    </div>
    <div class="col-md-4">
      <div class="dashboard-chart p-3 text-center"
        style="height: 320px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <h5 class="mb-2">Drawdown Over Time</h5>
        <canvas id="drawdownChart" style="max-width: 100%; max-height: 220px;"></canvas>
      </div>
    </div>
  </div>
  <!-- Fourth row: two wide charts -->
  <div class="row g-4 mb-5">
    <div class="col-md-6">
      <div class="dashboard-chart p-3 text-center"
        style="height: 400px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <h5 class="mb-2">Income Sources</h5>
        <canvas id="incomeSourcesChart" style="max-width: 100%; max-height: 320px;"></canvas>
      </div>
    </div>
    <div class="col-md-6">
      <div class="dashboard-chart p-3 text-center"
        style="height: 400px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <h5 class="mb-2">Income vs Expenses</h5>
        <canvas id="incomeExpensesChart" style="max-width: 100%; max-height: 220px;"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const dashboardData = JSON.parse(`{{ data|tojson|safe }}`);
  console.log("Dashboard Data:", dashboardData);

  //  Helper to get safe values
  const safe = (obj, path, def = 0) =>
    path.split('.').reduce((o, p) => (o ? o[p] : def), obj) ?? def;

 
    // ================================
    //  1. Assets vs Liabilities
    // ================================
    const assetsTotal = safe(dashboardData, 'assets.total');
    const liabilitiesTotal = safe(dashboardData, 'liabilities.total');
    console.log("Total assets : ", assetsTotal);
    const assetsChartEl = document.getElementById('assetsLiabilitiesChart');
    if (assetsChartEl && (assetsTotal || liabilitiesTotal)) {
      new Chart(document.getElementById('assetsLiabilitiesChart'), {
        type: 'doughnut',
        data: {
          labels: ['Assets', 'Liabilities'],
          datasets: [{
            data: [assetsTotal, liabilitiesTotal],
            backgroundColor: ['#4CAF50', '#F44336'],
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            title: { display: true, text: 'Assets vs Liabilities' }
          }
        }
      });
    } else {
      document.getElementById('assetsLiabilitiesChart').style.display = 'none';
    }

    // ================================
    //  2. Subscription Amount Chart
    // ================================
    /*const subItems = dashboardData.subscriptions?.items || [];
    if (subItems.length > 0) {
      const subLabels = subItems.map(item => item.name);
      const subValues = subItems.map(item => item.amount);

      new Chart(document.getElementById('debtPaydownChart'), {
        type: 'bar',
        data: {
          labels: subLabels,
          datasets: [{
            label: 'Amount ($)',
            data: subValues,
            backgroundColor: '#3bb3c3',
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: 'Subscriptions' }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    } else {
      document.getElementById('debtPaydownChart').style.display = 'none';
    }
    */
   
    // ================================
    //  3. Superannuation Growth
    // ================================
    const superYears = dashboardData.super?.years || [];
    const superBalance = dashboardData.super?.balance || [];

    if (superYears.length && superBalance.length) {
      new Chart(document.getElementById('superGrowthChart'), {
        type: 'line',
        data: {
          labels: superYears,
          datasets: [{
            label: 'Balance ($)',
            data: superBalance,
            borderColor: '#4e73df',
            fill: false,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: 'Superannuation Over Time' }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    } else {
      document.getElementById('superGrowthChart').style.display = 'none';
    }
   
    // ================================
    //  4. Expense Breakdown by Category
    // ================================
    const expenseItems = dashboardData.expenses?.items || [];
    if (expenseItems.length > 0) {
      const grouped = expenseItems.reduce((acc, item) => {
        acc[item.category] = (acc[item.category] || 0) + item.amount;
        return acc;
      }, {});

      const expenseLabels = Object.keys(grouped);
      const expenseValues = Object.values(grouped);

      new Chart(document.getElementById('expenseBreakdownChart'), {
        type: 'bar',
        data: {
          labels: expenseLabels,
          datasets: [{
            label: 'Amount ($)',
            data: expenseValues,
            backgroundColor: '#f6c23e',
          }]
        },
        options: {
          responsive: true,
          indexAxis: 'y',
          plugins: {
            legend: { display: false },
            title: { display: true, text: 'Expense Breakdown' }
          },
          scales: {
            x: { beginAtZero: true }
          }
        }
      });
    } else {
      document.getElementById('expenseBreakdownChart').style.display = 'none';
    }

    // ================================
    //  5. Drawdown Over Time
    // ================================
    const ddMonths = dashboardData.drawdown_over_time?.months || [];
    const ddValues = dashboardData.drawdown_over_time?.values || [];

    if (ddMonths.length && ddValues.length) {
      new Chart(document.getElementById('drawdownChart'), {
        type: 'line',
        data: {
          labels: ddMonths,
          datasets: [{
            label: 'Drawdown ($)',
            data: ddValues,
            borderColor: '#e74a3b',
            fill: false,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: 'Drawdown Over Time' }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    } else {
      document.getElementById('drawdownChart').style.display = 'none';
    }

    // ================================
    //  6. Income Sources
    // ================================
    const incomeItems = dashboardData.income?.items || [];

    if (incomeItems.length > 0) {
      const incomeLabels = incomeItems.map(item => item.label);
      const incomeValues = incomeItems.map(item => item.value);

      const ctxIncome = document.getElementById('incomeSourcesChart').getContext('2d');

      new Chart(ctxIncome, {
        type: 'pie',
        data: {
          labels: incomeLabels,
          datasets: [{
            data: incomeValues,
            backgroundColor: [
              '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
              '#858796', '#fd7e14', '#6f42c1', '#20c997'
            ],
            borderWidth: 1,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'right'
            },
            title: {
              display: true,
              text: 'Income Sources'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.raw;
                  const total = incomeValues.reduce((a,b) => a+b, 0);
                  const percent = ((value / total) * 100).toFixed(1);
                  return `${context.label}: $${value.toLocaleString()} (${percent}%)`;
                }
              }
            }
          }
        }
      });
    } else {
      document.getElementById('incomeSourcesChart').style.display = 'none';
    }

    // ================================
    //  7. Income vs Expenses
    // ================================
    const ctxIncomeExpenses = document.getElementById('incomeExpensesChart')?.getContext('2d');

    if (ctxIncomeExpenses) {
      const totalIncome = dashboardData.income?.total || 0;
      const totalExpenses = dashboardData.expenses?.total || 0;

      new Chart(ctxIncomeExpenses, {
        type: 'bar',
        data: {
          labels: ['Income', 'Expenses'],
          datasets: [{
            label: 'Amount ($)',
            data: [totalIncome, totalExpenses],
            backgroundColor: ['#4e73df', '#e74a3b']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: {
              display: true,
              text: 'Income vs Expenses'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `$${context.raw.toLocaleString()}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Amount ($)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Category'
              }
            }
          }
        }
      });
    } else {
      document.getElementById('incomeExpensesChart').style.display = 'none';
    }
 
</script>
{% endblock %}