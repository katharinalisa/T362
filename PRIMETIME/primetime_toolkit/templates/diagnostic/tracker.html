{% extends 'layout.html' %}
{% block content %}
<nav class="tracker-subnav">
  <ul>
    <li class="dropdown">
      <a href="#">Assets ▾</a>
      <ul class="dropdown-menu">
        <li><a href="#assets-list">View Assets</a></li>
        <li><a href="#add-asset">Add Asset</a></li>
      </ul>
    </li>
    <li class="dropdown">
      <a href="#">Liabilities ▾</a>
      <ul class="dropdown-menu">
        <li><a href="#liabilities-list">View Liabilities</a></li>
        <li><a href="#add-liability">Add Liability</a></li>
      </ul>
    </li>
    <li class="dropdown">
      <a href="#">Income ▾</a>
      <ul class="dropdown-menu">
        <li><a href="#income-list">View Income</a></li>
        <li><a href="#add-income">Add Income</a></li>
      </ul>
    </li>
    <li class="dropdown">
      <a href="#">Expenses ▾</a>
      <ul class="dropdown-menu">
        <li><a href="#expenses-list">View Expenses</a></li>
        <li><a href="#add-expense">Add Expense</a></li>
      </ul>
    </li>
    <li class="dropdown">
      <a href="#">Subscriptions ▾</a>
      <ul class="dropdown-menu">
        <li><a href="#subscriptions-list">View Subscriptions</a></li>
        <li><a href="#add-subscription">Add Subscription</a></li>
      </ul>
    </li>
  </ul>
</nav>
<div class="container py-5">
  <h1 class="text-center mb-4" style="color: #9E2A2B; font-family: 'Playfair Display', serif;">Net Worth Tracker</h1>
  <p class="text-center text-muted mb-4">(Total Assets - Total Liabilities)</p>

  <form method="POST" action="{{ url_for('views.submit_tracker') }}">
    <div class="bg-light p-3 rounded shadow-sm mb-4">
      <div class="row g-3">
        <div class="col-md-6"> 
          <label class="form-label fw-bold">Select Month</label>
          <select name="month" class="form-select" required>
            {% for m in ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'] %}
              <option value="{{ m }}">{{ m }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-bold">Year</label>
          <input type="number" name="year" class="form-control" required>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-success text-white fw-bold">Assets</div>
          <div class="card-body">
            {% for i in range(10) %}
            <div class="row mb-2">
              <div class="col-6"><input name="asset_name" class="form-control" placeholder="Asset Name" /></div>
              <div class="col-6">
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input name="asset_value" class="form-control asset-input" type="number" step="0.01" />
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-danger text-white fw-bold">Liabilities</div>
          <div class="card-body">
            {% for i in range(10) %}
            <div class="row mb-2">
              <div class="col-6"><input name="liability_name" class="form-control" placeholder="Liability Name" /></div>
              <div class="col-6">
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input name="liability_value" class="form-control liability-input" type="number" step="0.01" />
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4 mt-4">
      <div class="col-md-4">
        <label class="form-label fw-bold">Total Assets</label>
        <div class="input-group">
          <span class="input-group-text">$</span>
          <input type="text" id="totalAssets" class="form-control" readonly>
        </div>
        <input type="hidden" name="total_assets" id="hiddenTotalAssets">
      </div>
      <div class="col-md-4">
        <label class="form-label fw-bold">Total Liabilities</label>
        <div class="input-group">
          <span class="input-group-text">$</span>
          <input type="text" id="totalLiabilities" class="form-control" readonly>
        </div>
        <input type="hidden" name="total_liabilities" id="hiddenTotalLiabilities">
      </div>
      <div class="col-md-4">
        <label class="form-label fw-bold">Net Worth</label>
        <div class="input-group">
          <span class="input-group-text">$</span>
          <input type="text" id="netWorth" class="form-control" readonly>
        </div>
        <input type="hidden" name="net_worth" id="hiddenNetWorth">
      </div>
    </div>

    <div class="mt-4 mb-3">
      <label class="form-label fw-bold">Notes</label>
      <textarea name="notes" class="form-control" rows="4" placeholder="Add any relevant notes..."></textarea>
    </div>

    <div class="text-center">
      <button type="submit" class="btn btn-primary btn-lg">Save Tracker</button>
    </div>
    <div class="text-center mt-4">
      <button type="button" class="btn btn-outline-info" onclick="generateChart()">Generate Diagram</button>
    </div>

  </form>
</div>

<!-- Add this just before {% endblock %} -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let netWorthChart;

  function updateTotals() {
    const assetInputs = document.querySelectorAll(".asset-input");
    const liabilityInputs = document.querySelectorAll(".liability-input");
    let assetTotal = 0;
    let liabilityTotal = 0;

    assetInputs.forEach(input => assetTotal += parseFloat(input.value) || 0);
    liabilityInputs.forEach(input => liabilityTotal += parseFloat(input.value) || 0);

    document.getElementById("totalAssets").value = assetTotal.toFixed(2);
    document.getElementById("totalLiabilities").value = liabilityTotal.toFixed(2);
    document.getElementById("netWorth").value = (assetTotal - liabilityTotal).toFixed(2);

    document.getElementById("hiddenTotalAssets").value = assetTotal;
    document.getElementById("hiddenTotalLiabilities").value = liabilityTotal;
    document.getElementById("hiddenNetWorth").value = assetTotal - liabilityTotal;
  }

  function generateChart() {
    updateTotals(); // Ensure latest data

    const asset = parseFloat(document.getElementById("hiddenTotalAssets").value) || 0;
    const liability = parseFloat(document.getElementById("hiddenTotalLiabilities").value) || 0;
    const net = asset - liability;

    const ctx = document.getElementById('netWorthChart').getContext('2d');
    
    if (netWorthChart) {
      netWorthChart.destroy();
    }

    netWorthChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Assets', 'Liabilities', 'Net Worth'],
        datasets: [{
          label: 'AUD ($)',
          data: [asset, liability, net],
          backgroundColor: ['#4bc0c0', '#ff6384', '#9966ff'],
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  document.querySelectorAll(".asset-input, .liability-input").forEach(input => {
    input.addEventListener("input", updateTotals);
  });
</script>
